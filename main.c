#include <main.h>
#include <string.h>
#include <stdlib.h>

#fuses HS, WDT, PUT ,BROWNOUT, NOLVP 
#use delay(crystal=20000000)
#use rs232(baud=9600, xmit=PIN_C6, rcv=PIN_C7, parity=N, bits=8)

#use fast_io(b)
#use fast_io(d)
#use fast_io(e)

#define DS PIN_D0
#define SH_CP PIN_D2
#define ST_CP PIN_D1

 unsigned int Buffer[8][3] = {
                              {0,0,0},
                              {0,0,0},
                              {0,0,0},
                              {0,0,0},
                              {0,0,0},
                              {0,0,0},
                              {0,0,0},
                              {0,0,0}
                             };                           
const unsigned int Chars[95][8] ={
{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000},
{0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000000, 0b00000100},
{0b00001010, 0b00001010, 0b00001010, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000},
{0b00000000, 0b00001010, 0b00011111, 0b00001010, 0b00011111, 0b00001010, 0b00011111, 0b00001010},
{0b00000111, 0b00001100, 0b00010100, 0b00001100, 0b00000110, 0b00000101, 0b00000110, 0b00011100},
{0b00011001, 0b00011010, 0b00000010, 0b00000100, 0b00000100, 0b00001000, 0b00001011, 0b00010011},
{0b00000110, 0b00001010, 0b00010010, 0b00010100, 0b00001001, 0b00010110, 0b00010110, 0b00001001},
{0b00000100, 0b00000100, 0b00000100, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000},
{0b00000010, 0b00000100, 0b00001000, 0b00001000, 0b00001000, 0b00001000, 0b00000100, 0b00000010},
{0b00001000, 0b00000100, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000100, 0b00001000},
{0b00010101, 0b00001110, 0b00011111, 0b00001110, 0b00010101, 0b00000000, 0b00000000, 0b00000000},
{0b00000000, 0b00000000, 0b00000100, 0b00000100, 0b00011111, 0b00000100, 0b00000100, 0b00000000},
{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000110, 0b00000100, 0b00001000},
{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00001110, 0b00000000, 0b00000000, 0b00000000},
{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000100},
{0b00000001, 0b00000010, 0b00000010, 0b00000100, 0b00000100, 0b00001000, 0b00001000, 0b00010000},
{0b00001110, 0b00010001, 0b00010011, 0b00010001, 0b00010101, 0b00010001, 0b00011001, 0b00001110},
{0b00000100, 0b00001100, 0b00010100, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00011111},
{0b00001110, 0b00010001, 0b00010001, 0b00000010, 0b00000100, 0b00001000, 0b00010000, 0b00011111},
{0b00001110, 0b00010001, 0b00000001, 0b00001110, 0b00000001, 0b00000001, 0b00010001, 0b00001110},
{0b00010000, 0b00010000, 0b00010100, 0b00010100, 0b00011111, 0b00000100, 0b00000100, 0b00000100},
{0b00011111, 0b00010000, 0b00010000, 0b00011110, 0b00000001, 0b00000001, 0b00000001, 0b00011110},
{0b00000111, 0b00001000, 0b00010000, 0b00011110, 0b00010001, 0b00010001, 0b00010001, 0b00001110},
{0b00011111, 0b00000001, 0b00000001, 0b00000001, 0b00000010, 0b00000100, 0b00001000, 0b00010000},
{0b00001110, 0b00010001, 0b00010001, 0b00001110, 0b00010001, 0b00010001, 0b00010001, 0b00001110},
{0b00001110, 0b00010001, 0b00010001, 0b00001111, 0b00000001, 0b00000001, 0b00000001, 0b00000001},
{0b00000000, 0b00000100, 0b00000100, 0b00000000, 0b00000000, 0b00000100, 0b00000100, 0b00000000},
{0b00000000, 0b00000100, 0b00000100, 0b00000000, 0b00000000, 0b00000100, 0b00000100, 0b00001000},
{0b00000001, 0b00000010, 0b00000100, 0b00001000, 0b00001000, 0b00000100, 0b00000010, 0b00000001},
{0b00000000, 0b00000000,0b00000000, 0b00011110, 0b00000000,0b00011110, 0b00000000, 0b00000000},
{0b00010000, 0b00001000, 0b00000100, 0b00000010, 0b00000010, 0b00000100, 0b00001000, 0b00010000},
{0b00001110, 0b00010001, 0b00010001, 0b00000010, 0b00000100, 0b00000100, 0b00000000, 0b00000100},
{0b00001110, 0b00010001, 0b00010001, 0b00010101, 0b00010101, 0b00010001, 0b00010001, 0b00011110},
{0b00001110, 0b00010001, 0b00010001, 0b00010001, 0b00011111, 0b00010001, 0b00010001, 0b00010001},
{0b00011110, 0b00010001, 0b00010001, 0b00011110, 0b00010001, 0b00010001, 0b00010001, 0b00011110},
{0b00000111, 0b00001000, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00001000, 0b00000111},
{0b00011100, 0b00010010, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010010, 0b00011100},
{0b00011111, 0b00010000, 0b00010000, 0b00011110, 0b00010000, 0b00010000, 0b00010000, 0b00011111},
{0b00011111, 0b00010000, 0b00010000, 0b00011110, 0b00010000, 0b00010000, 0b00010000, 0b00010000},
{0b00001110, 0b00010001, 0b00010000, 0b00010000, 0b00010111, 0b00010001, 0b00010001, 0b00001110},
{0b00010001, 0b00010001, 0b00010001, 0b00011111, 0b00010001, 0b00010001, 0b00010001, 0b00010001},
{0b00011111, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00011111},
{0b00011111, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00010100, 0b00001000},
{0b00010001, 0b00010010, 0b00010100, 0b00011000, 0b00010100, 0b00010010, 0b00010001, 0b00010001},
{0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00011111},
{0b00010001, 0b00011011, 0b00011111, 0b00010101, 0b00010001, 0b00010001, 0b00010001, 0b00010001},
{0b00010001, 0b00011001, 0b00011001, 0b00010101, 0b00010101, 0b00010011, 0b00010011, 0b00010001},
{0b00001110, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00001110},
{0b00011110, 0b00010001, 0b00010001, 0b00011110, 0b00010000, 0b00010000, 0b00010000, 0b00010000},
{0b00001110, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010101, 0b00010011, 0b00001111},
{0b00011110, 0b00010001, 0b00010001, 0b00011110, 0b00010100, 0b00010010, 0b00010001, 0b00010001},
{0b00001110, 0b00010001, 0b00010000, 0b00001000, 0b00000110, 0b00000001, 0b00010001, 0b00001110},
{0b00011111, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000100},
{0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00001110},
{0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00001010, 0b00000100},
{0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010001, 0b00010101, 0b00010101, 0b00001010},
{0b00010001, 0b00010001, 0b00001010, 0b00000100, 0b00000100, 0b00001010, 0b00010001, 0b00010001},
{0b00010001, 0b00010001, 0b00001010, 0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00000100},
{0b00011111, 0b00000001, 0b00000010, 0b00000100, 0b00001000, 0b00010000, 0b00010000, 0b00011111},
{0b00001110, 0b00001000, 0b00001000, 0b00001000, 0b00001000, 0b00001000, 0b00001000, 0b00001110},
{0b00010000, 0b00001000, 0b00001000, 0b00000100, 0b00000100, 0b00000010, 0b00000010, 0b00000001},
{0b00001110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00001110},
{0b00000100, 0b00001010, 0b00010001, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000},
{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00011111},
{0b00001000, 0b00000100, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000},
{0b00000000, 0b00000000, 0b00000000, 0b00001110, 0b00010010, 0b00010010, 0b00010010, 0b00001111},
{0b00000000, 0b00010000, 0b00010000, 0b00010000, 0b00011100, 0b00010010, 0b00010010, 0b00011100},
{0b00000000, 0b00000000, 0b00000000, 0b00001110, 0b00010000, 0b00010000, 0b00010000, 0b00001110},
{0b00000000, 0b00000010, 0b00000010, 0b00000010, 0b00001110, 0b00010010, 0b00010010, 0b00001110},
{0b00000000, 0b00000000, 0b00000000, 0b00011100, 0b00010010, 0b00011110, 0b00010000, 0b00001110},
{0b00000000, 0b00000110, 0b00001000, 0b00001000, 0b00011100, 0b00001000, 0b00001000, 0b00001000},//f
{0b00000000, 0b00001110, 0b00001010, 0b00001010, 0b00001110, 0b00000010, 0b00000010, 0b00001100},
{0b00000000, 0b00010000, 0b00010000, 0b00010000, 0b00011100, 0b00010010, 0b00010010, 0b00010010},
{0b00000000, 0b00000000, 0b00000100, 0b00000000, 0b00000100, 0b00000100, 0b00000100, 0b00000100},
{0b00000000, 0b00000010, 0b00000000, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00001100},
{0b00000000, 0b00100000, 0b00100000, 0b00100100, 0b00101000, 0b00110000, 0b00101000, 0b00100100},//k
{0b00000000, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00001100},
{0b00000000, 0b00000000, 0b00000000, 0b00010100, 0b00101010, 0b00100010, 0b00100010, 0b00100010},
{0b00000000, 0b00000000, 0b00000000, 0b00010100, 0b00011010, 0b00010010, 0b00010010, 0b00010010},//n
{0b00000000, 0b00000000, 0b00000000, 0b00001100, 0b00010010, 0b00010010, 0b00010010, 0b00001100},
{0b00000000, 0b00011100, 0b00010010, 0b00010010, 0b00011100, 0b00010000, 0b00010000, 0b00010000},
{0b00000000, 0b00011100, 0b00100100, 0b00100100, 0b00011100, 0b00000100, 0b00000100, 0b00000010},
{0b00000000, 0b00000000, 0b00000000, 0b00010100, 0b00011000, 0b00010000, 0b00010000, 0b00010000},
{0b00000000, 0b00000000,0b00001110,  0b00010000, 0b00001000, 0b00000100, 0b00000010, 0b00011110},//s
{0b00000000, 0b00010000, 0b00010000, 0b00111100, 0b00010000, 0b00010000, 0b00010000, 0b00001100},
{0b00000000, 0b00000000, 0b00000000, 0b00010010, 0b00010010, 0b00010010, 0b00010010, 0b00001100},
{0b00000000, 0b00000000, 0b00000000, 0b00100010, 0b00100010, 0b00100010, 0b00010100, 0b00001000},
{0b00000000, 0b00000000, 0b00000000, 0b00100010, 0b00100010, 0b00100010, 0b00101010, 0b00010100},
{0b00000000, 0b00000000, 0b00000000, 0b00100010, 0b00010100, 0b00001000, 0b00010100, 0b00100010},
{0b00000000, 0b00100010, 0b00100010, 0b00100010, 0b00011110, 0b00000010, 0b00000010, 0b00011100},
{0b00000000, 0b00000000, 0b00000000, 0b00111110, 0b00000100, 0b00001000, 0b00010000, 0b00111110},
{0b00000010, 0b00000100, 0b00000100, 0b00000100, 0b00001000, 0b00000100, 0b00000100, 0b00000010},
{0b00000100, 0b00000100, 0b00000100, 0b00000100,0b00000100,0b00000100, 0b00000100, 0b00000100},
{0b00001000, 
0b00000100,
0b00000100,
0b00000100, 0b00000010, 0b00000100, 0b00000100, 0b00001000},
{0b00000000,0b00000000, 0b00000000, 0b00001010, 0b00011110, 0b00010100, 0b00000000, 0b00000000}
};

 
short durum_rda = 0;
char message[90] = " ";
unsigned int text_length = 0;
unsigned int d = 0;
#int_rda
void data()
{
disable_interrupts(int_rda);
output_high(PIN_E0);
delay_ms(1);
durum_rda = 1;
gets(message);
text_length = strlen(message);
write_eeprom(255, text_length);
for(d = 0; d<text_length; d++)
{
   write_eeprom(d,message[d]);
}

enable_interrupts(int_rda);
output_low(PIN_E0);
return;
}


void lock()
{
  output_high(ST_CP);
  output_low(ST_CP);
}

void clock()
{
  output_high(SH_CP);
  output_low(SH_CP);
}

void shift_data(unsigned int rw)
{
  unsigned int bit;
  unsigned int flag = 0;
  unsigned int num, t;

 for (num = 0; num < 3; num++) {
    bit = 0x01;
    for (t = 0; t < 8; t++) {
      flag = buffer[rw][num] & bit;
      if (flag == 0)
      {
        output_low(DS);
      }
      else 
      {
        output_high(DS);
      }
      bit = bit << 1;
      clock();

    }
  }
  lock();
}

  unsigned int i, z, length, index, temp;
  char speed_s[2] = "10";
  unsigned int speed = 10; 
  unsigned int j = 0;

void display()
{
for(i = 2; i<8; i++)
      {
        for(j = 0; j<8; j++)
        {
           restart_wdt();
           index = read_eeprom(length + 3);
           temp = Chars[index - 32][j];
           buffer[j][2] = (buffer[j][2] << 1) | (buffer[j][1] >> 7);
           buffer[j][1] = (buffer[j][1] << 1) | (buffer[j][0] >> 7);
           buffer[j][0] = (buffer[j][0] << 1) | (temp >> (7 - i));
        } 
        
         for (unsigned int l = 0; l < speed; l++) {
          unsigned int CLK = 1;      
          for (z = 0; z < 8; z++) {            
               shift_data(z); 
               output_b(CLK); 
               CLK = CLK<<1;
               delay_us(1000);                           
          } 
        } 
      } 
}


void main()
{
  setup_psp(PSP_DISABLED);
  setup_timer_1(T1_DISABLED);
  setup_timer_2(T2_DISABLED, 0, 1);
  setup_CCP1(CCP_OFF);
  setup_CCP2(CCP_OFF);
  setup_wdt(WDT_2304MS);
  enable_interrupts(INT_RDA);
  enable_interrupts(global);

  set_tris_b(0x00);
  set_tris_d(0x00);
  set_tris_e(0x00);

  output_b(0x00);
  output_d(0x00);
  output_e(0x00);
  
 while(true)
 {
   for(length = 1; length < 3; length++)
   {
     speed_s[length - 1] = read_eeprom(length);
   }
   speed = atoi(speed_s);
   text_length = read_eeprom(255);
   for(length = 0; length < text_length - 3; length++)
   {
     if(read_eeprom(0) != '#') 
     {
           if(durum_rda == 1)
           {
            durum_rda = 0;
            break;
           }
     }
     display();
   }   
 }
}

 
